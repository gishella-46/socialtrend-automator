input {
  # Laravel logs via UDP (port 5044)
  udp {
    port => 5044
    codec => json
    type => "laravel"
  }

  # FastAPI logs via TCP (port 5000)
  tcp {
    port => 5000
    codec => json_lines
    type => "fastapi"
  }

  # Nginx access logs
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    type => "nginx_access"
    codec => "json"
    sincedb_path => "/dev/null"
  }

  # Nginx error logs
  file {
    path => "/var/log/nginx/error.log"
    start_position => "beginning"
    type => "nginx_error"
    codec => "json"
    sincedb_path => "/dev/null"
  }
}

filter {
  # Parse Laravel logs
  if [type] == "laravel" {
    json {
      source => "message"
    }
    
    # Extract user_id if present
    if [context] {
      mutate {
        add_field => { "user_id" => "%{[context][user_id]}" }
      }
    }
    
    # Extract endpoint/route
    if [context] {
      mutate {
        add_field => { "endpoint" => "%{[context][route]}" }
        add_field => { "method" => "%{[context][method]}" }
      }
    }
    
    # Extract status_code
    if [context] {
      mutate {
        add_field => { "status_code" => "%{[context][status_code]}" }
      }
    }
    
    mutate {
      add_field => { "service" => "laravel" }
    }
  }

  # Parse FastAPI logs
  if [type] == "fastapi" {
    json {
      source => "message"
    }
    
    # Extract user_id from extra fields
    if [extra] {
      mutate {
        add_field => { "user_id" => "%{[extra][user_id]}" }
      }
    }
    
    # Extract endpoint
    if [extra] {
      mutate {
        add_field => { "endpoint" => "%{[extra][path]}" }
        add_field => { "method" => "%{[extra][method]}" }
      }
    }
    
    # Extract status_code
    if [extra] {
      mutate {
        add_field => { "status_code" => "%{[extra][status_code]}" }
      }
    }
    
    mutate {
      add_field => { "service" => "fastapi" }
    }
  }

  # Parse Nginx access logs (JSON format)
  if [type] == "nginx_access" {
    json {
      source => "message"
    }
    
    # Extract status_code from status field
    if [status] {
      mutate {
        rename => { "status" => "status_code" }
      }
    }
    
    # Extract endpoint from request
    if [request] {
      grok {
        match => { "request" => "%{WORD:method} %{URIPATH:endpoint}%{URIPARAM:params} HTTP/%{NUMBER}" }
      }
    }
    
    mutate {
      add_field => { "service" => "nginx" }
    }
  }

  # Parse Nginx error logs
  if [type] == "nginx_error" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{LOGLEVEL:level}\] %{NUMBER:pid}#%{NUMBER}: %{GREEDYDATA:error_message}" }
    }
    
    mutate {
      add_field => { "service" => "nginx" }
    }
  }

  # Common fields for all log types
  mutate {
    add_field => { "environment" => "production" }
  }

  # Date parsing (handle different timestamp formats)
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
    }
  } else {
    ruby {
      code => "event.set('@timestamp', Time.now.utc.iso8601)"
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "socialtrend-logs-%{+YYYY.MM.dd}"
  }

  # Debug output (optional, comment out in production)
  # stdout {
  #   codec => rubydebug
  # }
}

